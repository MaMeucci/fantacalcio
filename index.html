<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fantacalcio Schiera Drag&Drop Verticale</title>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
body { margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto; background:#f4f6f8;}
header { background:#111827; color:white; padding:14px; text-align:center; font-weight:600; font-size:18px;}
.container { padding:12px; }
.section { margin-bottom:18px; }
.section h2 { margin:6px 0; font-size:16px; }
.players { display:flex; flex-direction:column; gap:6px; padding:6px; background:#f0f0f0; border-radius:12px; min-height:50px;}
.player { padding:10px 12px; border-radius:12px; font-size:14px; cursor:grab; user-select:none; background:#e5e7eb; transition:all .2s; }
.player.p { background:#d1fae5; }
.player.d { background:#dbeafe; }
.player.c { background:#fef3c7; }
.player.a { background:#fee2e2; }
button { width:100%; padding:14px; border:none; border-radius:14px; background:#2563eb; color:white; font-size:16px; font-weight:600; margin-top:12px;}
textarea { width:100%; height:220px; margin-top:12px; padding:12px; border-radius:12px; border:1px solid #ccc; font-family:monospace; font-size:14px;}
</style>
</head>
<body>
<header>âš½ Fantacalcio Schiera Drag&Drop Verticale</header>
<div class="container">
<div id="titolari" class="section"></div>
<div id="panchina" class="section"></div>
<button onclick="generateOutput()">Genera output</button>
<textarea id="output" placeholder="Output finale..."></textarea>
</div>

<script>
let titolari=[], panchina=[];

// Carica rosa.txt
fetch('rosa.txt')
  .then(res => res.text())
  .then(text => {
    const parts = text.trim().split(/\n\s*\n/);
    titolari = parseBlock(parts[0]);
    panchina = parseBlock(parts[1]);
    render();
    initDragDrop();
  })
  .catch(err => alert("Errore caricamento rosa.txt: "+err));

function parseBlock(block){
  return block.split('\n').filter(Boolean).map(line=>{
    const [role,name] = line.split(';').map(s=>s.trim());
    return {role,name};
  });
}

// Render titolari/panchina
function render(){
  renderSection('Titolari', titolari, 'titolari');
  renderSection('Panchina', panchina, 'panchina');
}

function renderSection(title, arr, containerId){
  const container = document.getElementById(containerId);
  container.innerHTML = `<h2>${title}</h2>`;
  ['P','D','C','A'].forEach(r=>{
    const players = arr.filter(p=>p.role===r);
    if(!players.length) return;
    const div = document.createElement('div');
    div.className='players';
    div.id=containerId+'-'+r;
    players.forEach(p=>{
      const el = document.createElement('div');
      el.className = `player ${r.toLowerCase()}`;
      el.textContent = p.name;
      div.appendChild(el);
    });
    container.appendChild(div);
  });
}

// Drag&Drop con swap semplice tra titolari e panchina
function initDragDrop(){
  ['titolari','panchina'].forEach(sec=>{
    ['P','D','C','A'].forEach(r=>{
      const el = document.getElementById(sec+'-'+r);
      if(!el) return;
      Sortable.create(el,{
        group:'players',
        animation:150,
        onEnd: evt=>{
          const fromSec = evt.from.id.split('-')[0];
          const toSec = evt.to.id.split('-')[0];
          const role = evt.to.id.split('-')[1];
          const name = evt.item.textContent;

          const fromArr = fromSec==='titolari'?titolari:panchina;
          const toArr = toSec==='titolari'?titolari:panchina;

          // Rimuove dall'array originale
          const idx = fromArr.findIndex(p=>p.name===name && p.role===role);
          if(idx<0) return;
          const moved = fromArr.splice(idx,1)[0];

          // Inserisce nel nuovo array nella posizione corretta
          let targetIndices = [];
          toArr.forEach((p,i)=>{ if(p.role===role) targetIndices.push(i); });
          let newIndex = targetIndices[evt.newIndex]!==undefined?targetIndices[evt.newIndex]:toArr.length;
          toArr.splice(newIndex,0,moved);

          render();
          initDragDrop();
        }
      });
    });
  });
}

// Output
function generateOutput(){
  const out=[];
  ['titolari','panchina'].forEach(sec=>{
    const arr = sec==='titolari'?titolari:panchina;
    ['P','D','C','A'].forEach(r=>{
      arr.filter(p=>p.role===r).forEach(p=>out.push(p.role+';'+p.name+';'));
    });
    if(sec==='titolari') out.push('');
  });
  document.getElementById('output').value = out.join('\n');
}
</script>
</body>
</html>
