<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fantacalcio Drag&Drop Modulo</title>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
  background: #f4f6f8;
}

header {
  background: #111827;
  color: white;
  padding: 14px;
  text-align: center;
  font-weight: 600;
  font-size: 18px;
}

.container {
  padding: 12px;
}

select {
  width: 100%;
  padding: 12px;
  margin-bottom: 12px;
  border-radius: 12px;
  border: 1px solid #ccc;
  font-size: 16px;
}

.section {
  margin-bottom: 18px;
}

.section h2 {
  margin: 6px 0;
  font-size: 16px;
}

.players {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  min-height: 50px;
  padding: 6px;
  background: #f0f0f0;
  border-radius: 12px;
}

.player {
  padding: 10px 12px;
  border-radius: 12px;
  font-size: 14px;
  cursor: grab;
  user-select: none;
  background: #e5e7eb;
  transition: all .2s;
}

.player.selected { outline: 3px solid #000; background: white; }

.p { background: #d1fae5; }
.d { background: #dbeafe; }
.c { background: #fef3c7; }
.a { background: #fee2e2; }
.player.invalid { border: 2px solid red; }

button {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 14px;
  background: #2563eb;
  color: white;
  font-size: 16px;
  font-weight: 600;
}

textarea {
  width: 100%;
  height: 220px;
  margin-top: 12px;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid #ccc;
  font-family: monospace;
  font-size: 14px;
}
</style>
</head>
<body>

<header>⚽ Fantacalcio Drag&Drop Modulo</header>

<div class="container">

<select id="modulo" onchange="updateFormation()">
  <option value="3-4-3">3-4-3</option>
  <option value="4-3-3">4-3-3</option>
  <option value="4-4-2">4-4-2</option>
  <option value="3-5-2">3-5-2</option>
</select>

<div id="titolari" class="section"></div>
<div id="panchina" class="section"></div>

<button onclick="generateOutput()">Genera output</button>

<textarea id="output" placeholder="Output finale..."></textarea>

</div>

<script>
let titolari=[], panchina=[];
let moduloSelected = {P:1,D:4,C:4,A:2}; // default 4-4-2

// Carica rosa.txt automaticamente
fetch('rosa.txt')
  .then(res=>res.text())
  .then(text=>{
    const parts=text.trim().split(/\n\s*\n/);
    titolari=parseBlock(parts[0]);
    panchina=parseBlock(parts[1]);
    render();
    initDragDrop();
  })
  .catch(err=>alert("Errore caricamento rosa.txt: "+err));

function parseBlock(block){
  return block.split('\n')
    .map(l=>l.replace(';','').trim())
    .filter(Boolean)
    .map(name=>({name, role: roleMap[name]||'C', selected:true}));
}

function render(){
  renderSection('Titolari',titolari,'titolari');
  renderSection('Panchina',panchina,'panchina');
  validateFormation();
}

function renderSection(title,list,containerId){
  const container=document.getElementById(containerId);
  container.innerHTML=`<h2>${title}</h2>`;
  ['P','D','C','A'].forEach(r=>{
    const players=list.filter(p=>p.role===r);
    if(!players.length) return;
    const div=document.createElement('div');
    div.className='players';
    div.id=containerId+'-'+r;
    players.forEach(p=>{
      const el=document.createElement('div');
      el.className=`player ${p.selected?'selected':''} ${r.toLowerCase()}`;
      el.textContent=p.name;
      el.setAttribute('draggable',true);
      div.appendChild(el);
    });
    container.appendChild(div);
  });
}

// Drag&Drop con swap
function initDragDrop(){
  ['titolari','panchina'].forEach(sec=>{
    ['P','D','C','A'].forEach(r=>{
      const el=document.getElementById(sec+'-'+r);
      if(!el) return;
      Sortable.create(el,{
        group:'players',
        animation:150,
        swap:true,
        swapClass:'player-selected',
        onEnd:evt=>{
          const fromId=evt.from.id.split('-')[0];
          const toId=evt.to.id.split('-')[0];
          const role=evt.to.id.split('-')[1];
          swapPlayers(evt.item.textContent,fromId,toId,role);
        }
      });
    });
  });
}

function swapPlayers(name,fromSec,toSec,role){
  const fromArr=fromSec==='titolari'?titolari:panchina;
  const toArr=toSec==='titolari'?titolari:panchina;
  const idxFrom=fromArr.findIndex(p=>p.name===name);
  if(idxFrom<0) return;
  const dragged=fromArr.splice(idxFrom,1)[0];

  // se c'è già giocatore di questo ruolo nello stesso container, scambia
  const sameRole=toArr.filter(p=>p.role===role);
  if(sameRole.length>0){
    const swapIdx=toArr.findIndex(p=>p.name===sameRole[0].name);
    const temp=toArr[swapIdx];
    toArr[swapIdx]=dragged;
    fromArr.push(temp);
  }else{
    toArr.push(dragged);
  }

  render();
  initDragDrop();
}

// Aggiorna modulo
function updateFormation(){
  const val=document.getElementById('modulo').value;
  const nums=val.split('-').map(Number);
  moduloSelected = {P:1,D:nums[0],C:nums[1],A:nums[2]};
  validateFormation();
}

// Validazione modulo
function validateFormation(){
  ['P','D','C','A'].forEach(r=>{
    const count = titolari.filter(p=>p.role===r).length;
    const max = moduloSelected[r];
    titolari.forEach(p=>{
      if(p.role===r){
        const el=document.querySelector(`#titolari-${r} .player:contains("${p.name}")`) || document.querySelectorAll(`#titolari-${r} .player`)[0];
        if(!el) return;
        if(count>max) el.classList.add('invalid');
        else el.classList.remove('invalid');
      }
    });
  });
}

// Output
function generateOutput(){
  const out=[];
  titolari.forEach(p=>out.push(p.name+';'));
  out.push('');
  panchina.forEach(p=>out.push(p.name+';'));
  document.getElementById('output').value=out.join('\n');
}
</script>
</body>
</html>
